import{c as j,x as _,bj as L,h as C,r as x,j as e}from"./index-D9g1RJTX.js";/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const O=j("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]);/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const D=j("RefreshCcw",[["path",{d:"M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"14sxne"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16",key:"1hlbsb"}],["path",{d:"M16 16h5v5",key:"ccwih5"}]]);/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const T=j("Shield",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]]),M=a=>_({queryKey:["auditLogs",a],queryFn:async()=>{const s=await L(a);if(!s.ok)throw s.error;return s}}),w={"auth.login":"Đăng nhập","auth.logout":"Đăng xuất","sale.create":"Tạo hóa đơn","sale.delete":"Xóa hóa đơn","part.update_price":"Cập nhật giá phụ tùng","inventory.receipt":"Nhập kho","settings.update":"Cập nhật cài đặt","debt.customer_pay":"Thu nợ khách hàng","debt.supplier_pay":"Trả nợ nhà cung cấp","cash.manual":"Giao dịch quỹ thủ công"},R=()=>{var N;const{profile:a}=C(),[s,l]=x.useState(""),[r,h]=x.useState(50),[d,n]=x.useState(""),[i,m]=x.useState(""),[p,y]=x.useState(1),{data:c,isLoading:u,refetch:S}=M({action:s||void 0,page:p,pageSize:r,includeUser:!0,startDate:d?new Date(d).toISOString():void 0,endDate:i?new Date(i+"T23:59:59").toISOString():void 0}),o=(c==null?void 0:c.data)||[],f=((N=c==null?void 0:c.meta)==null?void 0:N.total)||0,b=Math.max(1,Math.ceil(f/r));return!a||a.role!=="owner"?e.jsxs("div",{className:"flex items-center justify-center h-96 text-slate-500 dark:text-slate-400",children:[e.jsx(T,{className:"w-5 h-5 mr-2"})," Chỉ chủ cửa hàng được xem nhật ký hệ thống."]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:"Nhật ký hệ thống"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:s,onChange:t=>l(t.target.value),className:"px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-sm",children:[e.jsx("option",{value:"",children:"Tất cả hành động"}),Object.entries(w).map(([t,g])=>e.jsx("option",{value:t,children:g},t))]}),e.jsx("input",{type:"date",value:d,onChange:t=>n(t.target.value),className:"px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-sm"}),e.jsx("input",{type:"date",value:i,onChange:t=>m(t.target.value),className:"px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-sm"}),e.jsx("select",{value:r,onChange:t=>h(parseInt(t.target.value)),className:"px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-sm",children:[25,50,100].map(t=>e.jsxs("option",{value:t,children:[t," dòng"]},t))}),e.jsxs("button",{onClick:()=>S(),className:"px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center gap-2 text-sm",children:[e.jsx(D,{className:"w-4 h-4"})," Tải lại"]}),e.jsx("button",{onClick:()=>U(o),className:"px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg flex items-center gap-2 text-sm",children:"JSON"}),e.jsx("button",{onClick:()=>$(o),className:"px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg flex items-center gap-2 text-sm",children:"CSV"})]})]}),e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow divide-y divide-slate-200 dark:divide-slate-700",children:[e.jsxs("div",{className:"p-4 flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-slate-600 dark:text-slate-400",children:u?"Đang tải...":`Hiển thị ${o.length} dòng • Trang ${p}/${b} • Tổng ${f}`}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>y(t=>Math.max(1,t-1)),disabled:p<=1,className:"px-3 py-1.5 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded disabled:opacity-50",children:"Trang trước"}),e.jsx("button",{onClick:()=>y(t=>Math.min(b,t+1)),disabled:p>=b,className:"px-3 py-1.5 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded disabled:opacity-50",children:"Trang sau"})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-slate-50 dark:bg-slate-700/50 text-slate-600 dark:text-slate-300",children:[e.jsx("th",{className:"text-left px-4 py-2 font-medium",children:"Thời gian"}),e.jsx("th",{className:"text-left px-4 py-2 font-medium",children:"Hành động"}),e.jsx("th",{className:"text-left px-4 py-2 font-medium",children:"Bảng"}),e.jsx("th",{className:"text-left px-4 py-2 font-medium",children:"ID bản ghi"}),e.jsx("th",{className:"text-left px-4 py-2 font-medium",children:"Dữ liệu"}),e.jsx("th",{className:"text-left px-4 py-2 font-medium",children:"User"})]})}),e.jsxs("tbody",{children:[u&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-4 py-6 text-center",children:e.jsx(O,{className:"w-6 h-6 animate-spin mx-auto text-slate-400"})})}),!u&&o.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-4 py-6 text-center text-slate-500",children:"Không có dữ liệu"})}),!u&&o.map(t=>{var k;const g=w[t.action]||t.action;return e.jsxs("tr",{className:"border-t border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/40",children:[e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-slate-700 dark:text-slate-300",children:new Date(t.created_at).toLocaleString("vi-VN")}),e.jsx("td",{className:"px-4 py-2 text-slate-700 dark:text-slate-300",children:g}),e.jsx("td",{className:"px-4 py-2 text-slate-600 dark:text-slate-400",children:t.table_name||"-"}),e.jsx("td",{className:"px-4 py-2 text-slate-600 dark:text-slate-400",children:t.record_id||"-"}),e.jsx("td",{className:"px-4 py-2 max-w-[280px]",children:e.jsx("pre",{className:"text-xs whitespace-pre-wrap break-all bg-slate-50 dark:bg-slate-900/40 p-2 rounded border border-slate-200 dark:border-slate-700 max-h-32 overflow-y-auto",children:t.new_data||t.old_data?JSON.stringify({old:t.old_data?v(t.old_data):void 0,new:t.new_data?v(t.new_data):void 0},null,2):"-"})}),e.jsx("td",{className:"px-4 py-2 text-slate-600 dark:text-slate-400",children:t.user_email||t.user_name?`${t.user_name||""} ${t.user_email?"<"+t.user_email+">":""}`.trim():((k=t.user_id)==null?void 0:k.slice(0,8))||"-"})]},t.id)})]})]})})]})]})};function v(a){try{return typeof a=="string"?JSON.parse(a):a}catch{return a}}function U(a){try{const s=new Blob([JSON.stringify(a,null,2)],{type:"application/json"}),l=URL.createObjectURL(s),r=document.createElement("a");r.href=l,r.download=`audit-logs-${new Date().toISOString()}.json`,r.click(),URL.revokeObjectURL(l)}catch{}}function $(a){try{const l=[["created_at","action","table_name","record_id","user_id","old_data","new_data"].join(",")];for(const n of a){const i=[n.created_at,n.action,n.table_name??"",n.record_id??"",n.user_id??"",JSON.stringify(n.old_data??""),JSON.stringify(n.new_data??"")].map(m=>`"${String(m).replace(/"/g,'""')}"`).join(",");l.push(i)}const r=new Blob([l.join(`
`)],{type:"text/csv;charset=utf-8;"}),h=URL.createObjectURL(r),d=document.createElement("a");d.href=h,d.download=`audit-logs-${new Date().toISOString()}.csv`,d.click(),URL.revokeObjectURL(h)}catch{}}export{R as AuditLogsViewer,R as default};
