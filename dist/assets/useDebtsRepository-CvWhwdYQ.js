import{n as c,v as i,w as d,a as p,y as h,x as g,s as u,a5 as m}from"./index-B2tLSL14.js";async function _(){try{const{data:n,error:e}=await c.from("customer_debts").select("*").order("created_at",{ascending:!1});if(e)return i({code:"supabase",message:"Không thể tải danh sách công nợ khách hàng",cause:e});const t=(n||[]).filter(r=>r.sale_id).map(r=>r.sale_id);let a=new Map;if(t.length>0){const{data:r}=await c.from("sales").select("id, sale_code").in("id",t);r&&r.forEach(o=>{o.sale_code&&a.set(o.id,o.sale_code)})}const s=(n||[]).map(r=>{let o=r.description;if(r.sale_id&&a.has(r.sale_id)){const l=a.get(r.sale_id);o=o.replace(/Hóa đơn SALE-\d+/g,`Hóa đơn ${l}`).replace(/Hóa đơn #\d+/g,`Hóa đơn ${l}`)}return{id:r.id,customerId:r.customer_id,customerName:r.customer_name,phone:r.phone,licensePlate:r.license_plate,description:o,totalAmount:r.total_amount,paidAmount:r.paid_amount,remainingAmount:r.remaining_amount,createdDate:r.created_date,branchId:r.branch_id}});return d(s)}catch(n){return i({code:"network",message:"Lỗi kết nối tới máy chủ",cause:n})}}async function f(n){try{const t={id:n.workOrderId?`CDEBT-WO-${n.workOrderId}`:n.saleId?`CDEBT-SALE-${n.saleId}`:`CDEBT-${Date.now()}`,customer_id:n.customerId,customer_name:n.customerName,phone:n.phone,license_plate:n.licensePlate,description:n.description,total_amount:n.totalAmount,paid_amount:n.paidAmount||0,remaining_amount:n.totalAmount-(n.paidAmount||0),created_date:n.createdDate,branch_id:n.branchId||"CN1",work_order_id:n.workOrderId||null,sale_id:n.saleId||null};console.log("[debtsRepository] Upserting debt:",t);let a;if(n.saleId){const{data:o,error:l}=await c.from("customer_debts").select("id").eq("sale_id",n.saleId).eq("branch_id",t.branch_id).maybeSingle();o&&!l?(console.log("[debtsRepository] Updating existing sale debt:",o.id),a=await c.from("customer_debts").update(t).eq("id",o.id).select().single()):(console.log("[debtsRepository] Inserting new sale debt"),a=await c.from("customer_debts").insert(t).select().single())}else if(n.workOrderId){const{data:o,error:l}=await c.from("customer_debts").select("id").eq("work_order_id",n.workOrderId).eq("branch_id",t.branch_id).maybeSingle();o&&!l?(console.log("[debtsRepository] Updating existing work order debt:",o.id),a=await c.from("customer_debts").update(t).eq("id",o.id).select().single()):(console.log("[debtsRepository] Inserting new work order debt"),a=await c.from("customer_debts").insert(t).select().single())}else console.log("[debtsRepository] Inserting generic debt"),a=await c.from("customer_debts").insert(t).select().single();const{data:s,error:r}=a;return r||!s?i({code:"supabase",message:(r==null?void 0:r.message)||"Không thể thêm/cập nhật công nợ",cause:r||new Error("No data returned")}):d({id:s.id,customerId:s.customer_id,customerName:s.customer_name,phone:s.phone,licensePlate:s.license_plate,description:s.description,totalAmount:s.total_amount,paidAmount:s.paid_amount,remainingAmount:s.remaining_amount,createdDate:s.created_date,branchId:s.branch_id})}catch(e){return i({code:"network",message:"Lỗi kết nối khi thêm/cập nhật công nợ",cause:e})}}async function y(n,e){try{const t={};e.customerName!==void 0&&(t.customer_name=e.customerName),e.phone!==void 0&&(t.phone=e.phone),e.licensePlate!==void 0&&(t.license_plate=e.licensePlate),e.description!==void 0&&(t.description=e.description),e.totalAmount!==void 0&&(t.total_amount=e.totalAmount),e.paidAmount!==void 0&&(t.paid_amount=e.paidAmount,t.remaining_amount=(e.totalAmount||0)-e.paidAmount),t.updated_at=new Date().toISOString();const{data:a,error:s}=await c.from("customer_debts").update(t).eq("id",n).select().single();return s||!a?i({code:"supabase",message:"Không thể cập nhật công nợ",cause:s}):d({id:a.id,customerId:a.customer_id,customerName:a.customer_name,phone:a.phone,licensePlate:a.license_plate,description:a.description,totalAmount:a.total_amount,paidAmount:a.paid_amount,remainingAmount:a.remaining_amount,createdDate:a.created_date,branchId:a.branch_id})}catch(t){return i({code:"network",message:"Lỗi kết nối khi cập nhật công nợ",cause:t})}}async function b(n){try{const{error:e}=await c.from("customer_debts").delete().eq("id",n);return e?i({code:"supabase",message:"Không thể xóa công nợ",cause:e}):d(void 0)}catch(e){return i({code:"network",message:"Lỗi kết nối khi xóa công nợ",cause:e})}}async function w(){try{const{data:n,error:e}=await c.from("supplier_debts").select("*").order("created_at",{ascending:!1});if(e)return i({code:"supabase",message:"Không thể tải danh sách công nợ nhà cung cấp",cause:e});const t=(n||[]).map(a=>({id:a.id,supplierId:a.supplier_id,supplierName:a.supplier_name,description:a.description,totalAmount:a.total_amount,paidAmount:a.paid_amount,remainingAmount:a.remaining_amount,createdDate:a.created_date,branchId:a.branch_id}));return d(t)}catch(n){return i({code:"network",message:"Lỗi kết nối tới máy chủ",cause:n})}}async function k(n){try{const e={id:`SDEBT-${Date.now()}`,supplier_id:n.supplierId,supplier_name:n.supplierName,description:n.description,total_amount:n.totalAmount,paid_amount:n.paidAmount||0,remaining_amount:n.totalAmount-(n.paidAmount||0),created_date:n.createdDate,branch_id:n.branchId||"CN1"},{data:t,error:a}=await c.from("supplier_debts").insert(e).select().single();return a||!t?i({code:"supabase",message:(a==null?void 0:a.message)||"Không thể thêm công nợ",cause:a||new Error("No data returned")}):d({id:t.id,supplierId:t.supplier_id,supplierName:t.supplier_name,description:t.description,totalAmount:t.total_amount,paidAmount:t.paid_amount,remainingAmount:t.remaining_amount,createdDate:t.created_date,branchId:t.branch_id})}catch(e){return i({code:"network",message:"Lỗi kết nối khi thêm công nợ",cause:e})}}async function A(n,e){try{const t={};e.supplierName!==void 0&&(t.supplier_name=e.supplierName),e.description!==void 0&&(t.description=e.description),e.totalAmount!==void 0&&(t.total_amount=e.totalAmount),e.paidAmount!==void 0&&(t.paid_amount=e.paidAmount,t.remaining_amount=(e.totalAmount||0)-e.paidAmount),t.updated_at=new Date().toISOString();const{data:a,error:s}=await c.from("supplier_debts").update(t).eq("id",n).select().single();return s||!a?i({code:"supabase",message:"Không thể cập nhật công nợ",cause:s}):d({id:a.id,supplierId:a.supplier_id,supplierName:a.supplier_name,description:a.description,totalAmount:a.total_amount,paidAmount:a.paid_amount,remainingAmount:a.remaining_amount,createdDate:a.created_date,branchId:a.branch_id})}catch(t){return i({code:"network",message:"Lỗi kết nối khi cập nhật công nợ",cause:t})}}async function D(n){try{const{error:e}=await c.from("supplier_debts").delete().eq("id",n);return e?i({code:"supabase",message:"Không thể xóa công nợ",cause:e}):d(void 0)}catch(e){return i({code:"network",message:"Lỗi kết nối khi xóa công nợ",cause:e})}}function C(){return g({queryKey:["customer_debts"],queryFn:async()=>{const n=await _();if(!n.ok)throw new Error(m(n.error));return n.data}})}function q(){const n=p();return h({mutationFn:async e=>{const t=await f(e);if(!t.ok){const a=t.error?m(t.error):"Không thể thêm công nợ";throw new Error(a)}return t.data},onSuccess:(e,t)=>{n.invalidateQueries({queryKey:["customer_debts"]}),t.saleId||u.success("Thêm công nợ thành công!")},onError:(e,t)=>{t.saleId||u.error((e==null?void 0:e.message)||"Có lỗi xảy ra")}})}function E(){const n=p();return h({mutationFn:async({id:e,updates:t})=>{const a=await y(e,t);if(!a.ok)throw new Error(m(a.error));return a.data},onSuccess:()=>{n.invalidateQueries({queryKey:["customer_debts"]}),u.success("Cập nhật công nợ thành công!")},onError:e=>{u.error((e==null?void 0:e.message)||"Có lỗi xảy ra")}})}function S(){const n=p();return h({mutationFn:async e=>{const t=await b(e);if(!t.ok)throw new Error(m(t.error));return t.data},onSuccess:()=>{n.invalidateQueries({queryKey:["customer_debts"]}),u.success("Xóa công nợ thành công!")},onError:e=>{u.error((e==null?void 0:e.message)||"Có lỗi xảy ra")}})}function v(){return g({queryKey:["supplier_debts"],queryFn:async()=>{const n=await w();if(!n.ok)throw new Error(m(n.error));return n.data}})}function K(){const n=p();return h({mutationFn:async e=>{const t=await k(e);if(!t.ok){const a=t.error?m(t.error):"Không thể thêm công nợ";throw new Error(a)}return t.data},onSuccess:()=>{n.invalidateQueries({queryKey:["supplier_debts"]}),u.success("Thêm công nợ thành công!")},onError:e=>{u.error((e==null?void 0:e.message)||"Có lỗi xảy ra")}})}function x(){const n=p();return h({mutationFn:async({id:e,updates:t})=>{const a=await A(e,t);if(!a.ok)throw new Error(m(a.error));return a.data},onSuccess:()=>{n.invalidateQueries({queryKey:["supplier_debts"]}),u.success("Cập nhật công nợ thành công!")},onError:e=>{u.error((e==null?void 0:e.message)||"Có lỗi xảy ra")}})}function N(){const n=p();return h({mutationFn:async e=>{const t=await D(e);if(!t.ok)throw new Error(m(t.error));return t.data},onSuccess:()=>{n.invalidateQueries({queryKey:["supplier_debts"]}),u.success("Xóa công nợ thành công!")},onError:e=>{u.error((e==null?void 0:e.message)||"Có lỗi xảy ra")}})}export{q as a,v as b,E as c,S as d,K as e,x as f,N as g,C as u};
