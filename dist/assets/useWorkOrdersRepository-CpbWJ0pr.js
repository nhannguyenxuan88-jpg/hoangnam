import{v as s,n as h,o as R,w as T,x as b,a as O,y as I,s as p,a5 as D}from"./index-B2tLSL14.js";const y="work_orders";function A(e){return{id:e.id,creationDate:e.creationdate||e.creationDate,customerName:e.customername||e.customerName,customerPhone:e.customerphone||e.customerPhone,vehicleModel:e.vehiclemodel||e.vehicleModel,licensePlate:e.licenseplate||e.licensePlate,issueDescription:e.issuedescript||e.issueDescription,technicianName:e.technicianname||e.technicianName,status:e.status,laborCost:e.laborcost||e.laborCost||0,discount:e.discount,partsUsed:e.partsused||e.partsUsed,additionalServices:e.additionalservices||e.additionalServices,notes:e.notes,total:e.total,branchId:e.branchid||e.branchId,depositAmount:e.depositamount||e.depositAmount,depositDate:e.depositdate||e.depositDate,depositTransactionId:e.deposittransactionid||e.depositTransactionId,paymentStatus:e.paymentstatus||e.paymentStatus,paymentMethod:e.paymentmethod||e.paymentMethod,additionalPayment:e.additionalpayment||e.additionalPayment,totalPaid:e.totalpaid||e.totalPaid,remainingAmount:e.remainingamount||e.remainingAmount,paymentDate:e.paymentdate||e.paymentDate,cashTransactionId:e.cashtransactionid||e.cashTransactionId,refunded:e.refunded,refunded_at:e.refunded_at||e.refundedAt,refund_transaction_id:e.refund_transaction_id||e.refundTransactionId,refund_reason:e.refund_reason||e.refundReason}}async function U(){try{const{data:e,error:t}=await h.from(y).select("*").order("creationdate",{ascending:!1});return console.log("[fetchWorkOrders] Raw data from DB:",e),console.log("[fetchWorkOrders] Status values:",e==null?void 0:e.map(r=>({id:r.id,status:r.status}))),t?s({code:"supabase",message:"Không thể tải danh sách phiếu sửa chữa",cause:t}):T((e||[]).map(A))}catch(e){return s({code:"network",message:"Lỗi kết nối tới máy chủ",cause:e})}}async function S(e){var t;try{if(!e.id)return s({code:"validation",message:"Thiếu ID phiếu sửa chữa"});const r={p_order_id:e.id,p_customer_name:e.customerName||"",p_customer_phone:e.customerPhone||"",p_vehicle_model:e.vehicleModel||"",p_license_plate:e.licensePlate||"",p_issue_description:e.issueDescription||"",p_technician_name:e.technicianName||"",p_status:e.status||"Tiếp nhận",p_labor_cost:e.laborCost||0,p_discount:e.discount||0,p_parts_used:e.partsUsed||[],p_additional_services:e.additionalServices||null,p_total:e.total||0,p_branch_id:e.branchId||"CN1",p_payment_status:e.paymentStatus||"unpaid",p_payment_method:e.paymentMethod||null,p_deposit_amount:e.depositAmount||0,p_additional_payment:e.additionalPayment||0,p_user_id:null};console.log("[DEBUG] Creating work order with payload:",JSON.stringify(r,null,2));const{data:o,error:a}=await h.rpc("work_order_create_atomic",r);if(console.log("[DEBUG] RPC Response - data:",o,"error:",a),a&&console.error("[DEBUG] RPC Error Details:",{code:a.code,message:a.message,details:a.details,hint:a.hint,fullError:JSON.stringify(a,null,2)}),a||!o){const d=(a==null?void 0:a.details)||(a==null?void 0:a.message)||"",i=d.toUpperCase();if(i.includes("INSUFFICIENT_STOCK")){let N=[];const C=d.indexOf(":");if(C!==-1){const g=d.slice(C+1).trim();try{N=JSON.parse(g)}catch{}}const q=Array.isArray(N)?N.map(g=>`${g.partName||g.partId||"?"} (còn ${g.available}, cần ${g.requested})`).join(", "):"";return s({code:"validation",message:q?`Thiếu tồn kho: ${q}`:"Tồn kho không đủ cho một hoặc nhiều phụ tùng",cause:a})}return i.includes("PART_NOT_FOUND")?s({code:"validation",message:"Không tìm thấy phụ tùng trong kho",cause:a}):i.includes("INVALID_PART")?s({code:"validation",message:"Dữ liệu phụ tùng không hợp lệ",cause:a}):i.includes("INVALID_STATUS")?s({code:"validation",message:"Trạng thái không hợp lệ",cause:a}):i.includes("INVALID_PAYMENT_STATUS")?s({code:"validation",message:"Trạng thái thanh toán không hợp lệ",cause:a}):i.includes("UNAUTHORIZED")?s({code:"supabase",message:"Bạn không có quyền tạo phiếu sửa chữa",cause:a}):i.includes("BRANCH_MISMATCH")?s({code:"validation",message:"Chi nhánh không khớp với quyền hiện tại",cause:a}):s({code:"supabase",message:"Tạo phiếu sửa chữa (atomic) thất bại",cause:a})}const n=o.workOrder,u=o.orderId,f=o.depositTransactionId,k=o.paymentTransactionId,m=o.inventoryTxCount,c=o.stockWarnings,_=o.inventoryDeducted;if(!n&&!u)return s({code:"unknown",message:"Kết quả RPC không hợp lệ"});let l=null;if(n)l=A(n);else if(u){const{data:d,error:i}=await h.from(y).select("*").eq("id",u).single();i?console.error("[createWorkOrderAtomic] Cannot fetch order by ID",{orderId:u,fetchError:i}):d&&(l=A(d))}if(!l)return s({code:"supabase",message:"Không thể tải dữ liệu phiếu sửa chữa vừa tạo"});let v=null;try{const{data:d}=await h.auth.getUser();v=((t=d==null?void 0:d.user)==null?void 0:t.id)||null}catch{}return await R(v,{action:"work_order.create",tableName:y,recordId:l.id,oldData:null,newData:l}),T({...l,depositTransactionId:f,paymentTransactionId:k,inventoryTxCount:m,stockWarnings:c,inventoryDeducted:_})}catch(r){return s({code:"network",message:"Lỗi kết nối khi tạo phiếu sửa chữa (atomic)",cause:r})}}async function K(e){var t;try{if(!e.id)return s({code:"validation",message:"Thiếu ID phiếu sửa chữa"});const r={p_order_id:e.id,p_customer_name:e.customerName||"",p_customer_phone:e.customerPhone||"",p_vehicle_model:e.vehicleModel||"",p_license_plate:e.licensePlate||"",p_issue_description:e.issueDescription||"",p_technician_name:e.technicianName||"",p_status:e.status||"Tiếp nhận",p_labor_cost:e.laborCost||0,p_discount:e.discount||0,p_parts_used:e.partsUsed||[],p_additional_services:e.additionalServices||null,p_total:e.total||0,p_payment_status:e.paymentStatus||"unpaid",p_payment_method:e.paymentMethod||null,p_deposit_amount:e.depositAmount||0,p_additional_payment:e.additionalPayment||0,p_user_id:null},{data:o,error:a}=await h.rpc("work_order_update_atomic",r);if(a||!o){const c=(a==null?void 0:a.details)||(a==null?void 0:a.message)||"",_=c.toUpperCase();if(_.includes("INSUFFICIENT_STOCK")){let l=[];const v=c.indexOf(":");if(v!==-1){const i=c.slice(v+1).trim();try{l=JSON.parse(i)}catch{}}const d=Array.isArray(l)?l.map(i=>`${i.partName||i.partId||"?"} (còn ${i.available}, cần ${i.requested})`).join(", "):"";return s({code:"validation",message:d?`Thiếu tồn kho: ${d}`:"Tồn kho không đủ cho một hoặc nhiều phụ tùng",cause:a})}return _.includes("ORDER_NOT_FOUND")?s({code:"validation",message:"Không tìm thấy phiếu sửa chữa",cause:a}):_.includes("PART_NOT_FOUND")?s({code:"validation",message:"Không tìm thấy phụ tùng trong kho",cause:a}):_.includes("INVALID_PART")?s({code:"validation",message:"Dữ liệu phụ tùng không hợp lệ",cause:a}):_.includes("UNAUTHORIZED")?s({code:"supabase",message:"Bạn không có quyền cập nhật phiếu sửa chữa",cause:a}):_.includes("BRANCH_MISMATCH")?s({code:"validation",message:"Chi nhánh không khớp với quyền hiện tại",cause:a}):s({code:"supabase",message:"Cập nhật phiếu sửa chữa (atomic) thất bại",cause:a})}const n=o.workOrder,u=o.depositTransactionId,f=o.paymentTransactionId,k=o.stockWarnings;if(!n)return s({code:"unknown",message:"Kết quả RPC không hợp lệ"});let m=null;try{const{data:c}=await h.auth.getUser();m=((t=c==null?void 0:c.user)==null?void 0:t.id)||null}catch{}return await R(m,{action:"work_order.update",tableName:y,recordId:n.id,oldData:null,newData:n}),T({...n,depositTransactionId:u,paymentTransactionId:f,stockWarnings:k})}catch(r){return s({code:"network",message:"Lỗi kết nối khi cập nhật phiếu sửa chữa (atomic)",cause:r})}}async function P(e){var t;try{const{error:r}=await h.from(y).delete().eq("id",e);if(r)return s({code:"supabase",message:"Không thể xóa phiếu sửa chữa",cause:r});let o=null;try{const{data:a}=await h.auth.getUser();o=((t=a==null?void 0:a.user)==null?void 0:t.id)||null}catch{}return await R(o,{action:"work_order.delete",tableName:y,recordId:e,oldData:null,newData:null}),T(void 0)}catch(r){return s({code:"network",message:"Lỗi kết nối khi xóa phiếu sửa chữa",cause:r})}}async function E(e,t){var r;try{let o=null;try{const{data:m}=await h.auth.getUser();o=((r=m==null?void 0:m.user)==null?void 0:r.id)||null}catch{}const{data:a,error:n}=await h.rpc("work_order_refund_atomic",{p_order_id:e,p_refund_reason:t,p_user_id:o||"unknown"});if(n||!a){console.error("[refundWorkOrder] RPC error:",n),console.error("[refundWorkOrder] Error code:",n==null?void 0:n.code),console.error("[refundWorkOrder] Error message:",n==null?void 0:n.message),console.error("[refundWorkOrder] Error details:",n==null?void 0:n.details);const c=((n==null?void 0:n.details)||(n==null?void 0:n.message)||"").toUpperCase();return c.includes("ORDER_NOT_FOUND")?s({code:"validation",message:"Không tìm thấy phiếu sửa chữa",cause:n}):c.includes("ALREADY_REFUNDED")?s({code:"validation",message:"Phiếu này đã được hoàn tiền rồi",cause:n}):c.includes("UNAUTHORIZED")?s({code:"supabase",message:"Bạn không có quyền hoàn tiền",cause:n}):c.includes("BRANCH_MISMATCH")?s({code:"validation",message:"Chi nhánh không khớp với quyền hiện tại",cause:n}):s({code:"supabase",message:`Hoàn tiền thất bại: ${(n==null?void 0:n.message)||"Unknown error"}`,cause:n})}const u=a.workOrder,f=a.refund_transaction_id,k=a.refundAmount;return u?(await R(o,{action:"work_order.refund",tableName:y,recordId:e,oldData:null,newData:u}),T({...u,refund_transaction_id:f,refundAmount:k})):s({code:"unknown",message:"Kết quả RPC không hợp lệ"})}catch(o){return s({code:"network",message:"Lỗi kết nối khi hoàn tiền",cause:o})}}const Q=()=>b({queryKey:["workOrdersRepo"],queryFn:async()=>{const e=await U();if(!e.ok)throw e.error;return e.data}}),F=()=>{const e=O();return I({mutationFn:async t=>{const r=await S(t);if(!r.ok)throw r.error;return r.data},onSuccess:t=>{e.invalidateQueries({queryKey:["workOrdersRepo"]}),e.invalidateQueries({queryKey:["partsRepo"]}),e.invalidateQueries({queryKey:["partsRepoPaged"]}),e.invalidateQueries({queryKey:["inventoryTxRepo"]}),p.success("Đã tạo phiếu sửa chữa (atomic)"),t!=null&&t.inventoryTxCount&&p.info(`Xuất kho: ${t.inventoryTxCount} phụ tùng`)},onError:t=>p.error(D(t))})},M=()=>{const e=O();return I({mutationFn:async t=>{const r=await K(t);if(!r.ok)throw r.error;return r.data},onSuccess:()=>{e.invalidateQueries({queryKey:["workOrdersRepo"]}),e.invalidateQueries({queryKey:["partsRepo"]}),e.invalidateQueries({queryKey:["partsRepoPaged"]}),e.invalidateQueries({queryKey:["inventoryTxRepo"]}),p.success("Đã cập nhật lệnh sửa chữa")},onError:t=>p.error(D(t))})},w=()=>{const e=O();return I({mutationFn:({id:t})=>P(t),onSuccess:()=>{e.invalidateQueries({queryKey:["workOrdersRepo"]}),e.invalidateQueries({queryKey:["partsRepo"]}),e.invalidateQueries({queryKey:["partsRepoPaged"]}),e.invalidateQueries({queryKey:["inventoryTxRepo"]}),p.success("Đã hủy lệnh sửa chữa")},onError:t=>p.error(D(t))})},x=()=>{const e=O();return I({mutationFn:({orderId:t,refundReason:r})=>E(t,r),onSuccess:t=>{e.invalidateQueries({queryKey:["workOrdersRepo"]}),e.invalidateQueries({queryKey:["partsRepo"]}),e.invalidateQueries({queryKey:["partsRepoPaged"]}),e.invalidateQueries({queryKey:["inventoryTxRepo"]}),p.success("Đã hoàn tiền phiếu sửa chữa"),t.ok&&t.data.refundAmount&&p.info(`Hoàn tiền: ${new Intl.NumberFormat("vi-VN").format(t.data.refundAmount)}đ`)},onError:t=>p.error(D(t))})};export{x as a,w as b,F as c,M as d,Q as u};
