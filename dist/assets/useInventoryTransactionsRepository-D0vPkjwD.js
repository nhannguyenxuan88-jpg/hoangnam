import{a as g,y as I,v as i,n as s,o as f,w as l,x as v,s as y,a5 as k}from"./index-B2tLSL14.js";const u="inventory_transactions";async function w(e){try{let t=s.from(u).select("id,type,partId,partName,quantity,date,unitPrice,totalPrice,branchId,notes,saleId,workOrderId,created_at").order("created_at",{ascending:!1});e!=null&&e.branchId&&(t=t.eq("branchId",e.branchId)),e!=null&&e.startDate&&(t=t.gte("date",e.startDate)),e!=null&&e.endDate&&(t=t.lte("date",e.endDate)),e!=null&&e.limit&&(t=t.limit(e.limit));const{data:n,error:a}=await t;return a?i({code:"supabase",message:(a==null?void 0:a.message)||(a==null?void 0:a.details)||"Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ kho",cause:a}):l(n||[])}catch(t){return i({code:"network",message:"L·ªói k·∫øt n·ªëi khi t·∫£i l·ªãch s·ª≠ kho",cause:t})}}async function q(e){var t;try{if(!e.partId||!e.partName)return i({code:"validation",message:"Thi·∫øu th√¥ng tin ph·ª• t√πng"});if(!e.quantity||e.quantity<=0)return i({code:"validation",message:"S·ªë l∆∞·ª£ng ph·∫£i > 0"});if(!e.branchId)return i({code:"validation",message:"Thi·∫øu chi nh√°nh"});if(!e.type)return i({code:"validation",message:"Thi·∫øu lo·∫°i giao d·ªãch kho"});const n=e.unitPrice??0,a=e.totalPrice??n*e.quantity,c={id:typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`${Math.random().toString(36).slice(2)}-${Date.now()}`,type:e.type,partId:e.partId,partName:e.partName,quantity:e.quantity,date:e.date||new Date().toISOString(),unitPrice:n||null,totalPrice:a,branchId:e.branchId,notes:e.notes,saleId:e.saleId,workOrderId:e.workOrderId},{data:o,error:r}=await s.from(u).insert([c]).select().single();if(r||!o)return i({code:"supabase",message:(r==null?void 0:r.message)||(r==null?void 0:r.details)||"Ghi l·ªãch s·ª≠ kho th·∫•t b·∫°i",cause:r});let h=null;try{const{data:d}=await s.auth.getUser();h=((t=d==null?void 0:d.user)==null?void 0:t.id)||null}catch{}return await f(h,{action:e.type==="Nh·∫≠p kho"?"inventory.receipt":"inventory.adjust",tableName:u,recordId:o.id,oldData:null,newData:o}),l(o)}catch(n){return i({code:"network",message:"L·ªói k·∫øt n·ªëi khi ghi l·ªãch s·ª≠ kho",cause:n})}}async function b(e,t,n,a,c){try{const{data:o,error:r}=await s.rpc("receipt_create_atomic",{p_items:e,p_supplier_id:t,p_branch_id:n,p_user_id:a,p_notes:c});return r?i({code:"supabase",message:r.message,cause:r}):o&&!o.success?i({code:"validation",message:o.message}):l(o)}catch(o){return i({code:"network",message:"L·ªói k·∫øt n·ªëi khi t·∫°o phi·∫øu nh·∫≠p",cause:o})}}function _(){const e=g();return I({mutationFn:async t=>{const n=await b(t.items,t.supplierId,t.branchId,t.userId,t.notes);if(!n.ok)throw n.error;return n.data},onSuccess:()=>{e.invalidateQueries({queryKey:["inventoryTransactions"]}),e.invalidateQueries({queryKey:["inventoryTxRepo"]}),e.invalidateQueries({queryKey:["partsRepo"]}),e.invalidateQueries({queryKey:["partsRepoPaged"]})}})}const R=e=>v({queryKey:["inventoryTxRepo",e],queryFn:async()=>{const t=await w(e);if(!t.ok)throw t.error;return t.data}}),m=()=>{const e=g();return I({mutationFn:async t=>{console.log("üî• ƒêang g·ªçi createInventoryTransaction v·ªõi input:",t);const n=await q(t);if(console.log("üî• K·∫øt qu·∫£ createInventoryTransaction:",n),!n.ok)throw n.error||new Error("L·ªói kh√¥ng x√°c ƒë·ªãnh");return n.data},onSuccess:()=>{console.log("‚úÖ L∆∞u l·ªãch s·ª≠ th√†nh c√¥ng!"),e.invalidateQueries({queryKey:["inventoryTxRepo"]}),y.success("ƒê√£ ghi l·ªãch s·ª≠ kho")},onError:t=>{console.error("‚ùå L·ªói l∆∞u l·ªãch s·ª≠:",t),y.error(k(t))}})};export{_ as a,R as b,m as u};
